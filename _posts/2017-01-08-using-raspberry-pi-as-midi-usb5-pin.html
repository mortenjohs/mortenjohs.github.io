---
layout: post
title: Using a Raspberry Pi as a MIDI USB/5-pin bridge
date: '2017-01-08T23:46:00.006+01:00'
author: Morten
tags:
- music making
- howto
- Linux
- Pi
- hack
- iPad
- fix
- Ruby
- Programming
- music
- Hardware
- MIDI
modified_time: '2017-01-08T23:51:44.227+01:00'
thumbnail: https://3.bp.blogspot.com/--qPHA3Y3NTg/WHK2QaXnftI/AAAAAAACfMw/trBaRjNW-i4_8no4o6i9gHjqcR3_WvMpACLcB/s72-c/IMG_20161223_200030.jpg
blogger_id: tag:blogger.com,1999:blog-6967032375013519080.post-6762372744835640758
blogger_orig_url: https://m635j520.blogspot.com/2017/01/using-raspberry-pi-as-midi-usb5-pin.html
---

In my constant... need... to get everything music instrument related to communicate with each other, I wanted to look into ways to get some of my keyboards/synths with only MIDI over USB to talk to devices with regular good old-fashioned 5-pin MIDI ports from the eighties.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://www.instagram.com/p/BOXuDKbDvO7AMe8yrjjLnh-KEpBM7n4ot8wvlQ0" style="margin-left: auto; margin-right: auto;" target="_blank"><img border="0" height="320" src="https://3.bp.blogspot.com/--qPHA3Y3NTg/WHK2QaXnftI/AAAAAAACfMw/trBaRjNW-i4_8no4o6i9gHjqcR3_WvMpACLcB/s320/IMG_20161223_200030.jpg" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Cables!</td></tr></tbody></table><br />First I had a quick look at off the shelf solutions. The most interesting one being the <a href="http://www.kentonuk.com/products/items/utilities/usb-host.shtml" target="_blank">Kenton MIDI USB Host</a> – providing MIDI host functionality for USB devices as well as regular MIDI in and out in a small box. Unfortunately it is rather expensive (~125 €) and a reliable online source warned me that it was not entirely stable in collaboration with my OP-1, so I started thinking of more... home-grown solutions.<br /><br />I decided to try to use my old <a href="https://m635j520.blogspot.fr/2014/07/introducing-noisevote-or-democratising.html" target="_blank">Raspberry Pi</a> and see if that would serve as a USB host with a borrowed MIDI USB adapter. (Thanks Simon.) A cheaper, and, as an added boon, a nerdier solution.<br /><h4>Step 1: Get the USB MIDI device up and running</h4>This was the easy part. The device I have been lent is a very straight forward <a href="http://www.creative.com/emu/products/product.aspx?pid=19089" target="_blank">Creative Technology, Ltd E-Mu Xmidi 1x1</a>. This was picked up by the ALSA drivers on the Pi. (If you don't have ALSA already installed it is just a matter of doing a <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sudo apt-get install alsa</span>, basically.) The USB-only MIDI device I wanted to use for testing was my good old road-worn class-compliant <a href="http://www.m-audio-france.com/products/view/keystation-mini-32" target="_blank">M-Audio KeyStation 32</a>. Plugged and it in and it was picked up by the system.<br /><h4>Step 2: Connect the two worlds</h4>To be able to route MIDI from the one to the other we need to use <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aconnect</span>. (This should come with your ALSA installation.) A quick <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">aconnect -i</span>&nbsp;will list all the input ports of your connected MIDI devices. (Along with some concepts of through and system.) Here's what my system looks like at this point:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pi@raspberrypi ~ $ aconnect -i</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 0: 'System' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'Timer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 1 'Announce &nbsp; &nbsp; &nbsp; &nbsp;'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 14: 'Midi Through' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'Midi Through Port-0'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 16: 'Keystation Mini 32' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'Keystation Mini 32 MIDI 1'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 20: 'E-MU XMidi1X1' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'E-MU XMidi1X1 MIDI 1'&nbsp;</span><br /><br /><span style="font-family: inherit;">The important part is the number after each keyword client. They tell you how to refer to the different devices when connecting them. So, if we want to send signals from the only port (0) of the Keystation Mini (client 16) to the only port (0) of the 5-pin out (client 20) we can set up a connection using the command:</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pi@raspberrypi ~ $ aconnect 16:0 20:0</span><br /><br />Voila, if we inspect the connections again (with an added <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-l</span>) it will report this:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pi@raspberrypi ~ $ aconnect -i -l</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 0: 'System' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'Timer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 1 'Announce &nbsp; &nbsp; &nbsp; &nbsp;'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 14: 'Midi Through' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'Midi Through Port-0'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 16: 'Keystation Mini 32' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'Keystation Mini 32 MIDI 1'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>Connecting To: 20:0</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">client 20: 'E-MU XMidi1X1' [type=kernel]</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; 0 'E-MU XMidi1X1 MIDI 1'</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span class="Apple-tab-span" style="white-space: pre;"> </span>Connected From: 16:0</span><br /><br />To test this marvel I hooked up my Volca FM to the receiving end of the MIDI chain, and lo and behold it received glorious MIDI signals and spat out magnificent frequency modulated digital synthesis!<br /><br />The way this works at this point in the story is that I hook the Pi up to the ethernet at home – with the midi devices already hooked up. Then I SSH to it from my computer and execute the commands listed above. Hardly ideal for a situation anywhere out in the real world, so I looked into ways to automate it. I wanted to automatically create the connections when I plug the devices...<br /><h4>Step 3: Automatic connection</h4>The first thing I did was to write a script that connects the various devices as they are connected. I picked Ruby as scripting language of choice. (bash would probably be a more sane choice, but I like my daily dose of ruby...)<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pi@raspberrypi ~ $ cat dev/ruby/midiconnect/connectall.rb</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#!/usr/bin/ruby</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">t = `aconnect -i -l`</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">ports = []</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">t.lines.each do |l|</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; /client (\d*)\:/=~l</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; port = $1</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; # we skip empty lines and the "Through" port</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; ports &lt;&lt; port unless $1.nil? || $1 == '0' || /Through/=~l</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">ports.each do |p1|</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; ports.each do |p2|</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; unless p1 == p2 # probably not a good idea to connect a port to itself</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; system &nbsp;"aconnect #{p1}:0 #{p2}:0"</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; end</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; end</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">end</span><br /><br />(This is a rather brute force way of doing this as it will connect everything to everything but itself. The bonus is that if I connect several MIDI related devices using a USB hub everything will be connected to everything.)<br /><br />And it worked, so I created a convenience wrapper in a bash script for it, like so:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pi@raspberrypi ~ $ cat bin/connectall.sh</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#!/bin/bash</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">#</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/usr/bin/ruby /home/pi/dev/ruby/midiconnect/connectall.rb</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span><span style="font-family: inherit;">One </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">chmod&nbsp;+x</span><span style="font-family: inherit;"> later and it is really easy to reestablish connections semi-automatically.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">I added this script to the boot up sequence of the Pi, but that meant that I needed to reboot it if I do any changes. Hardly ideal, so I wanted to take it further.</span><br /><h4>Step 4: Automatic detection</h4>Next up is to set up automatic detection of my USB devices. To accomplish this I'll rely on udev and sets of rules based on hardware IDs of the devices in question – <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">lsusb</span> to the resque.<br /><br />If we run <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">lsusb</span> we get a list of USB devices connected to the system. Like so, for example:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pi@raspberrypi ~ $ lsusb</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Bus 001 Device 002: ID 0424:9512 Standard Microsystems Corp.</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp.</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Bus 001 Device 012: ID 0a4d:129d Evolution Electronics, Ltd</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Bus 001 Device 009: ID 041e:3f07 Creative Technology, Ltd E-Mu Xmidi 1x1</span><br /><br />The devices we are after are the two last entries. (Sometimes the list might be slightly cryptic, so you might want to run <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">lsusb</span> before and after connecting the device to see what has changed.)<br /><br />We see that the Keystation has a hexadecimal vendor ID of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">0a4d</span> and a ditto device ID of <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">129d</span>, so we can add a file called, for example, <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">99-keystation-mini.rules</span> in the <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">/etc/udev/rules.d/</span> folder containing:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">ATTRS{idVendor}=="0a4d", ATTRS{idProduct}=="129d", RUN+="/home/pi/bin/connectall.sh"&nbsp;</span><br /><br />I added one similar file per USB MIDI device I want the Pi to be able to talk to and we are good to go. Reload the udev rules with a&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sudo udevadm control --reload-rules </span><span style="font-family: inherit;">and we can plug and play as we want.</span><br /><h4>Final notes</h4><div>Now I have a stand alone little gadget that bridges the world of USB MIDI and the world of standard 5-pin MIDI. The Raspberry Pi is powered by standard 5V over micro USB, so I've hooked it up to the USB port of my power bank I use for guitar pedals, volcas, etc. This means it can be used in the shade in a parc.</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://www.instagram.com/p/2VrvVmls4XX8VqIOFcYgwLhV5Ey-l2rJ08YZM0" style="margin-left: auto; margin-right: auto;" target="_blank"><img border="0" height="320" src="https://1.bp.blogspot.com/-Fx-xWrvAKrI/WHK3EnViBLI/AAAAAAACfM4/l9qRpxDnyVME98OBiaV3P1RSkQT8rGGFgCLcB/s320/IMG_20150506_132751.jpg" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Outdoor season with 1bisHill.</td></tr></tbody></table><div><br /></div>There must be more generic solutions to this – using other things than udev, maybe? But, hey, this works for me for now, so further optimisation will have to wait. Other kinds of things to look into would be:<br /><br /><ul><li>Fancy routing options? Especially if more devices are hooked up with a USB hub?</li><li>MIDI filtering/translations?</li><li>Security-wise it is probably not a good idea to let the udev call scripts in my home dir, but this is really handy... (I should look into what user level these things run under...)</li></ul><div>I have had some weird issues with my OP-1 not sending MIDI signals some times with this setup just after hooking things up. (The solution, bizarrely, seems to be swapping between COM programs, and then going into synth mode, and it works again.) However this is also happening when I use it as a MIDI controller hooked up to my mac so I won't blame the Pi for this yet. Also, once things are connected it works like a charm. (Touch wood.)</div><div><br /></div><div>If I need more on the fly configurability I might still want to try to use my iPad coupled with a USB hub as a bridge (using apps like midiflow or similar to do the routing), but I'm happy with the added portability (and nerd-cred) from the solving this with the Pi.</div><h4>References</h4>Luckily others has done some of this before, so I could base my work on their findings. I found the following URLs helpful:<br /><ul><li>Basically a better write up of step 1 and 2 above can be found here:&nbsp;<a href="http://sandsoftwaresound.net/send-midi-from-usb-b-to-5-pin/">http://sandsoftwaresound.net/send-midi-from-usb-b-to-5-pin/</a>&nbsp;</li><li>My main source of information for step 4:&nbsp;<a href="https://unix.stackexchange.com/questions/65891/how-to-execute-a-shellscript-when-i-plug-in-a-usb-device">https://unix.stackexchange.com/questions/65891/how-to-execute-a-shellscript-when-i-plug-in-a-usb-device</a></li><li>And:&nbsp;<a href="https://raspberrypi.stackexchange.com/questions/19600/is-there-a-way-to-automatically-activate-a-script-when-a-usb-device-connects">https://raspberrypi.stackexchange.com/questions/19600/is-there-a-way-to-automatically-activate-a-script-when-a-usb-device-connects</a></li><li>And:&nbsp;<a href="https://stimresp.wordpress.com/2016/02/08/using-a-raspberry-pi-as-usb-midi-host/">https://stimresp.wordpress.com/2016/02/08/using-a-raspberry-pi-as-usb-midi-host/</a></li><li>The great Cuckoo discussing the Kenton MIDI USB Host:&nbsp;<a href="https://youtu.be/s6D9jafo5_I?t=8m20s">https://youtu.be/s6D9jafo5_I?t=8m20s</a>&nbsp;(Bonus: lots of Volca FM sounds!)</li></ul>